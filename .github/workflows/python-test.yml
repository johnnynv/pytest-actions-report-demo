name: Python CI

on:
  pull_request: {}
  push:
    branches: [ main, release/* ]

permissions:
  checks: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxml2-utils
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-html pytest-cov

    - name: Run tests and record results
      id: run-tests
      run: |
        cd tests
        PYTHONPATH=../src pytest \
          --cov=../src \
          --cov-report=xml:../coverage-${{ matrix.python-version }}.xml \
          --junitxml=../test-results-${{ matrix.python-version }}.xml \
          --html=../report-${{ matrix.python-version }}.html \
          --self-contained-html
        
        # ç²¾ç¡®è§£æžæµ‹è¯•ç»“æžœ
        passed=$(xmllint --xpath 'count(//testcase[not(skipped) and not(failure) and not(error)])' ../test-results-${{ matrix.python-version }}.xml || echo "0")
        failures=$(xmllint --xpath 'count(//testcase[failure])' ../test-results-${{ matrix.python-version }}.xml || echo "0")
        errors=$(xmllint --xpath 'count(//testcase[error])' ../test-results-${{ matrix.python-version }}.xml || echo "0")
        skipped=$(xmllint --xpath 'count(//testcase[skipped])' ../test-results-${{ matrix.python-version }}.xml || echo "0")
        xfailed=$(xmllint --xpath 'count(//testcase[contains(@name, "[xfail]")])' ../test-results-${{ matrix.python-version }}.xml || echo "0")
        xpassed=$(xmllint --xpath 'count(//testcase[contains(@name, "[xpass]")])' ../test-results-${{ matrix.python-version }}.xml || echo "0")
        actual_passed=$((passed - xpassed))

        # è¾“å‡ºå½“å‰ job ç»“æžœ
        echo "::group::ðŸ“Š Python ${{ matrix.python-version }} Test Summary"
        echo "âœ… Passed: $actual_passed"
        echo "âŒ Failed: $failures"
        echo "â© Skipped: $skipped"
        echo "ðŸ’¥ Errors: $errors"
        echo "ðŸ”¶ XFailed: $xfailed"
        echo "âš ï¸ XPassed: $xpassed"
        echo "::endgroup::"

        # å°†ç»“æžœå†™å…¥æ–‡ä»¶ä¾› summary job ä½¿ç”¨
        echo "PY${PY_VER}_PASSED=$actual_passed" >> $GITHUB_OUTPUT
        echo "PY${PY_VER}_FAILED=$failures" >> $GITHUB_OUTPUT
        echo "PY${PY_VER}_SKIPPED=$skipped" >> $GITHUB_OUTPUT
        echo "PY${PY_VER}_ERRORS=$errors" >> $GITHUB_OUTPUT
        echo "PY${PY_VER}_XFAILED=$xfailed" >> $GITHUB_OUTPUT
        echo "PY${PY_VER}_XPASSED=$xpassed" >> $GITHUB_OUTPUT

        # åŒæ—¶å†™å…¥çŽ¯å¢ƒå˜é‡ï¼ˆå…¼å®¹æ€§ï¼‰
        PY_VER=$(echo "${{ matrix.python-version }}" | tr -d '.')
        echo "PY${PY_VER}_PASSED=$actual_passed" >> $GITHUB_ENV
        echo "PY${PY_VER}_FAILED=$failures" >> $GITHUB_ENV
        echo "PY${PY_VER}_SKIPPED=$skipped" >> $GITHUB_ENV
        echo "PY${PY_VER}_ERRORS=$errors" >> $GITHUB_ENV
        echo "PY${PY_VER}_XFAILED=$xfailed" >> $GITHUB_ENV
        echo "PY${PY_VER}_XPASSED=$xpassed" >> $GITHUB_ENV

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-results-py${{ matrix.python-version }}
        path: |
          report-${{ matrix.python-version }}.html
          coverage-${{ matrix.python-version }}.xml
          test-results-${{ matrix.python-version }}.xml

    # è¾“å‡ºç»“æžœä¾›å…¶ä»– job ä½¿ç”¨
    outputs:
      py38_passed: ${{ steps.run-tests.outputs.PY38_PASSED }}
      py38_failed: ${{ steps.run-tests.outputs.PY38_FAILED }}
      py38_skipped: ${{ steps.run-tests.outputs.PY38_SKIPPED }}
      py38_errors: ${{ steps.run-tests.outputs.PY38_ERRORS }}
      py38_xfailed: ${{ steps.run-tests.outputs.PY38_XFAILED }}
      py38_xpassed: ${{ steps.run-tests.outputs.PY38_XPASSED }}
      # ä¸ºå…¶ä»– Python ç‰ˆæœ¬æ·»åŠ ç›¸åŒè¾“å‡º...

  summary:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Collect test results
        run: |
          echo "PY38_PASSED=${{ needs.test.outputs.py38_passed || '0' }}" >> $GITHUB_ENV
          echo "PY38_FAILED=${{ needs.test.outputs.py38_failed || '0' }}" >> $GITHUB_ENV
          echo "PY38_SKIPPED=${{ needs.test.outputs.py38_skipped || '0' }}" >> $GITHUB_ENV
          echo "PY38_ERRORS=${{ needs.test.outputs.py38_errors || '0' }}" >> $GITHUB_ENV
          echo "PY38_XFAILED=${{ needs.test.outputs.py38_xfailed || '0' }}" >> $GITHUB_ENV
          echo "PY38_XPASSED=${{ needs.test.outputs.py38_xpassed || '0' }}" >> $GITHUB_ENV
          # ä¸ºå…¶ä»– Python ç‰ˆæœ¬æ·»åŠ ç›¸åŒçŽ¯å¢ƒå˜é‡...

      - name: Generate final report
        run: |
          echo "### ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Python Version | âœ… Passed | âŒ Failed | â© Skipped | ðŸ’¥ Errors | ðŸ”¶ XFailed | âš ï¸ XPassed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|----------|----------|-----------|----------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| 3.8 | ${PY38_PASSED:-0} | ${PY38_FAILED:-0} | ${PY38_SKIPPED:-0} | ${PY38_ERRORS:-0} | ${PY38_XFAILED:-0} | ${PY38_XPASSED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.9 | ${PY39_PASSED:-0} | ${PY39_FAILED:-0} | ${PY39_SKIPPED:-0} | ${PY39_ERRORS:-0} | ${PY39_XFAILED:-0} | ${PY39_XPASSED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.10 | ${PY310_PASSED:-0} | ${PY310_FAILED:-0} | ${PY310_SKIPPED:-0} | ${PY310_ERRORS:-0} | ${PY310_XFAILED:-0} | ${PY310_XPASSED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.11 | ${PY311_PASSED:-0} | ${PY311_FAILED:-0} | ${PY311_SKIPPED:-0} | ${PY311_ERRORS:-0} | ${PY311_XFAILED:-0} | ${PY311_XPASSED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View Detailed Reports]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> $GITHUB_STEP_SUMMARY
