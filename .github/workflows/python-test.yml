name: Python CI

on: [push, pull_request]

permissions:
  checks: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-html pytest-cov

    - name: Run tests and record results
      id: run-tests
      run: |
        cd tests
        # è¿è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
        PYTHONPATH=../src pytest \
          --cov=../src \
          --cov-report=xml:../coverage-${{ matrix.python-version }}.xml \
          --junitxml=../test-results-${{ matrix.python-version }}.xml \
          --html=../report-${{ matrix.python-version }}.html \
          --self-contained-html
        
        # ç›´æ¥ä»HTMLæŠ¥å‘Šæå–æµ‹è¯•ç»“æœï¼ˆæ›´å¯é çš„æ–¹å¼ï¼‰
        passed=$(awk '/<td>passed<\/td><td>/ {getline; print}' ../report-${{ matrix.python-version }}.html | grep -o '[0-9]\+' || echo "0")
        failed=$(awk '/<td>failed<\/td><td>/ {getline; print}' ../report-${{ matrix.python-version }}.html | grep -o '[0-9]\+' || echo "0")
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "PASSED=$passed" >> $GITHUB_OUTPUT
        echo "FAILED=$failed" >> $GITHUB_OUTPUT
        
        # ä¸ºsummary jobè®¾ç½®ç¯å¢ƒå˜é‡
        PY_VER=$(echo "${{ matrix.python-version }}" | tr '.' '_')
        echo "PY${PY_VER}_PASSED=$passed" >> $GITHUB_ENV
        echo "PY${PY_VER}_FAILED=$failed" >> $GITHUB_ENV
        
        # æ‰“å°ç»“æœç”¨äºè°ƒè¯•
        echo "Test results for Python ${{ matrix.python-version }}: Passed=$passed, Failed=$failed"
      shell: bash

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-results-py${{ matrix.python-version }}
        path: |
          report-${{ matrix.python-version }}.html
          coverage-${{ matrix.python-version }}.xml
          test-results-${{ matrix.python-version }}.xml

  summary:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Generate final report
        run: |
          echo "### ğŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Python Version | Passed | Failed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 3.8 | ${PY3_8_PASSED:-0} | ${PY3_8_FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.9 | ${PY3_9_PASSED:-0} | ${PY3_9_FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.10 | ${PY3_10_PASSED:-0} | ${PY3_10_FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.11 | ${PY3_11_PASSED:-0} | ${PY3_11_FAILED:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š [View Detailed Reports]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> $GITHUB_STEP_SUMMARY
          
          # æ‰“å°ç¯å¢ƒå˜é‡ç”¨äºè°ƒè¯•
          echo "Current environment variables:"
          printenv | grep PY

