name: Python CI

on: [push, pull_request]

permissions:
  checks: write  # 仅需检查状态写入权限
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install package in editable mode
      run: |
        pip install -e .
        pip install pytest pytest-html pytest-cov

    - name: Run tests with coverage
      run: |
        cd tests  # 确保在tests目录执行
        PYTHONPATH=../src pytest \
          --cov=../src \
          --cov-report=xml \
          --html=report.html \
          --self-contained-html

    - name: Move report to root
      run: mv tests/report.html ./

    - name: Generate summary
      run: |
        echo "### 📊 Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- 🔍 [Download HTML Report](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> $GITHUB_STEP_SUMMARY
        grep -o 'passed.*</td>\|failed.*</td>' report.html | sed 's/<.*//' >> $GITHUB_STEP_SUMMARY

    - name: Upload reports
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          report.html
          coverage.xml

